<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>幸運扭蛋機</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Lucide 圖示庫 -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @keyframes churn {
            0% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(15px, -15px) rotate(90deg); }
            50% { transform: translate(-20px, 10px) rotate(180deg); }
            75% { transform: translate(10px, 20px) rotate(270deg); }
            100% { transform: translate(0, 0) rotate(360deg); }
        }
        .animate-churn {
            animation: churn 0.6s infinite ease-in-out;
        }
        @keyframes drop {
            0% { transform: translateY(-50px) scale(0.5); opacity: 0; }
            100% { transform: translateY(0) scale(1); opacity: 1; }
        }
        .animate-drop {
            animation: drop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        .capsule-half {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 50%;
            background-color: rgba(255, 255, 255, 0.3);
            border-top-left-radius: 9999px;
            border-top-right-radius: 9999px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body class="min-h-screen bg-slate-100 flex flex-col items-center py-8 px-4 font-sans text-slate-900">

    <div class="max-w-md w-full bg-white rounded-3xl shadow-2xl overflow-hidden border-4 border-slate-200">
        
        <!-- Header -->
        <div class="bg-indigo-600 p-6 text-white text-center">
            <h1 class="text-3xl font-bold tracking-wider">幸運扭蛋機</h1>
            <p class="mt-2 opacity-80" id="count-display">剩餘扭蛋：10 / 10</p>
        </div>

        <!-- Machine Body -->
        <div class="p-8 flex flex-col items-center bg-gradient-to-b from-slate-50 to-slate-200">
            
            <!-- Transparent Globe -->
            <div id="globe" class="relative w-72 h-72 bg-white/40 border-4 border-slate-300 rounded-full shadow-inner flex flex-wrap justify-center items-center p-8 overflow-hidden mb-8">
                <!-- Inner glow effect -->
                <div class="absolute inset-0 bg-gradient-to-tr from-white/30 to-transparent pointer-events-none z-10"></div>
                
                <!-- Capsules Container -->
                <div id="capsules-container" class="relative w-full h-full flex flex-wrap justify-center items-center transition-transform duration-300">
                    <!-- Capsules will be generated here -->
                </div>

                <div id="sold-out-overlay" class="hidden absolute inset-0 flex items-center justify-center z-20 bg-slate-100/20 backdrop-blur-[1px]">
                    <div class="text-slate-400 font-black text-2xl animate-pulse tracking-widest border-2 border-slate-300 px-4 py-2 rounded-lg rotate-12">SOLD OUT</div>
                </div>
            </div>

            <!-- Controls Panel -->
            <div class="w-full bg-slate-700 rounded-3xl p-6 shadow-xl relative border-b-8 border-slate-800">
                <!-- The Knob -->
                <div class="flex justify-center mb-6">
                    <button id="spin-button" class="w-28 h-28 rounded-full border-8 border-slate-800 shadow-2xl flex items-center justify-center transition-all active:scale-90 relative overflow-hidden bg-slate-500 text-white hover:bg-slate-600 cursor-pointer">
                        <div id="knob-part-1" class="w-20 h-4 bg-slate-800 rounded-full absolute transition-transform duration-700 rotate-45"></div>
                        <div id="knob-part-2" class="w-20 h-4 bg-slate-800 rounded-full absolute transition-transform duration-700 -rotate-45"></div>
                        <div class="z-10 bg-slate-700 p-2 rounded-full shadow-inner">
                            <i data-lucide="play" id="play-icon" class="w-8 h-8 fill-current"></i>
                            <div id="spinner" class="hidden w-8 h-8 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
                        </div>
                    </button>
                </div>

                <!-- Exit Slot -->
                <div class="w-36 h-20 bg-slate-900 mx-auto rounded-t-2xl shadow-inner flex items-center justify-center relative border-x-4 border-t-4 border-slate-800 overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-b from-black/50 to-transparent"></div>
                    <div id="slot-glow" class="hidden w-12 h-12 rounded-full bg-slate-400/20 animate-pulse"></div>
                    <div id="exit-capsule" class="hidden w-12 h-12 rounded-full animate-drop shadow-lg border-2 border-white/50 relative">
                        <div class="capsule-half"></div>
                    </div>
                    <div class="absolute bottom-1 text-slate-600 text-[10px] font-bold uppercase tracking-widest z-10">OUTPUT</div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex p-4 gap-4 bg-white border-t border-slate-100">
            <button id="reset-button" class="flex-1 flex items-center justify-center gap-2 bg-slate-100 hover:bg-slate-200 text-slate-700 py-3 rounded-xl font-bold transition-colors">
                <i data-lucide="refresh-cw" class="w-[18px]"></i> 重設機器
            </button>
        </div>
    </div>

    <!-- History Section -->
    <div class="max-w-md w-full mt-8">
        <div class="flex items-center gap-2 text-slate-600 mb-4 px-2">
            <i data-lucide="history" class="w-5"></i>
            <h2 class="font-bold">抽取紀錄</h2>
        </div>
        <div id="history-container" class="flex flex-wrap gap-2">
            <p class="text-slate-400 text-sm italic px-2">尚未有抽取紀錄...</p>
        </div>
    </div>

    <!-- Result Modal -->
    <div id="modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-md flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-[40px] p-10 max-w-xs w-full text-center shadow-2xl border-8 border-indigo-100">
            <h3 class="text-3xl font-black text-indigo-900 mb-8 tracking-tighter">YOU GOT!</h3>
            
            <div class="relative inline-block mb-8">
                <div id="modal-glow" class="absolute -inset-4 rounded-full blur-xl opacity-50"></div>
                <div id="modal-capsule" class="w-36 h-36 rounded-full flex items-center justify-center text-white text-6xl font-black shadow-2xl relative border-4 border-white animate-bounce">
                    <span id="result-number"></span>
                    <div class="capsule-half"></div>
                </div>
            </div>

            <p class="text-slate-400 mb-8 font-bold text-lg uppercase tracking-widest" id="capsule-label"></p>
            
            <button id="close-modal" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-black py-5 rounded-2xl shadow-[0_8px_0_rgb(49,46,129)] transition-all active:translate-y-1 active:shadow-none">
                收下扭蛋
            </button>
        </div>
    </div>

    <div class="mt-12 text-slate-400 text-sm flex items-center gap-1">
        <i data-lucide="info" class="w-[14px]"></i> 點擊旋鈕觀察扭蛋翻滾的過程
    </div>

    <script>
        // 初始化 Lucide 圖示
        lucide.createIcons();

        // 狀態
        let capsules = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
        let history = [];
        let isSpinning = false;

        // 音訊合成器 (Web Audio API)
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let spinInterval = null;

        function playClickSound() {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'square';
            osc.frequency.setValueAtTime(150, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        }

        function playWinSound() {
            const notes = [523.25, 659.25, 783.99, 1046.50]; // C5, E5, G5, C6
            notes.forEach((freq, i) => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime + i * 0.1);
                gain.gain.setValueAtTime(0, audioCtx.currentTime + i * 0.1);
                gain.gain.linearRampToValueAtTime(0.2, audioCtx.currentTime + i * 0.1 + 0.05);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + i * 0.1 + 0.4);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start(audioCtx.currentTime + i * 0.1);
                osc.stop(audioCtx.currentTime + i * 0.1 + 0.4);
            });
        }

        const colors = [
            'bg-red-400', 'bg-blue-400', 'bg-yellow-400', 
            'bg-green-400', 'bg-purple-400', 'bg-pink-400', 
            'bg-orange-400', 'bg-indigo-400', 'bg-teal-400', 'bg-rose-400'
        ];

        // DOM 元素
        const capsulesContainer = document.getElementById('capsules-container');
        const spinButton = document.getElementById('spin-button');
        const countDisplay = document.getElementById('count-display');
        const historyContainer = document.getElementById('history-container');
        const modal = document.getElementById('modal');
        const resultNumber = document.getElementById('result-number');
        const closeModal = document.getElementById('close-modal');
        const resetButton = document.getElementById('reset-button');
        const soldOutOverlay = document.getElementById('sold-out-overlay');
        const exitCapsule = document.getElementById('exit-capsule');
        const slotGlow = document.getElementById('slot-glow');
        const spinner = document.getElementById('spinner');
        const playIcon = document.getElementById('play-icon');
        const knobPart1 = document.getElementById('knob-part-1');
        const knobPart2 = document.getElementById('knob-part-2');
        const modalCapsule = document.getElementById('modal-capsule');
        const modalGlow = document.getElementById('modal-glow');
        const capsuleLabel = document.getElementById('capsule-label');

        function renderCapsules() {
            capsulesContainer.innerHTML = '';
            capsules.forEach((num, idx) => {
                const div = document.createElement('div');
                div.className = `w-12 h-12 rounded-full border-2 border-white/50 shadow-lg flex items-center justify-center m-1 transition-all relative ${colors[num-1]} ${isSpinning ? 'animate-churn' : 'hover:scale-110'}`;
                div.style.animationDelay = `${idx * 0.05}s`;
                div.style.zIndex = Math.floor(Math.random() * 10);
                
                const half = document.createElement('div');
                half.className = 'capsule-half';
                div.appendChild(half);
                
                const span = document.createElement('span');
                span.className = 'text-white/20 font-bold text-xs pointer-events-none';
                span.innerText = num;
                div.appendChild(span);
                
                capsulesContainer.appendChild(div);
            });
            countDisplay.innerText = `剩餘扭蛋：${capsules.length} / 10`;
            
            if (capsules.length === 0) {
                soldOutOverlay.classList.remove('hidden');
                spinButton.classList.add('opacity-50', 'grayscale', 'cursor-not-allowed');
                spinButton.disabled = true;
            } else {
                soldOutOverlay.classList.add('hidden');
                spinButton.classList.remove('opacity-50', 'grayscale', 'cursor-not-allowed');
                spinButton.disabled = false;
            }
        }

        function renderHistory() {
            if (history.length === 0) {
                historyContainer.innerHTML = '<p class="text-slate-400 text-sm italic px-2">尚未有抽取紀錄...</p>';
                return;
            }
            historyContainer.innerHTML = '';
            history.forEach(num => {
                const div = document.createElement('div');
                div.className = `${colors[num-1]} w-10 h-10 rounded-full flex items-center justify-center text-white text-xs font-bold shadow-sm border-2 border-white animate-drop`;
                div.innerText = num;
                historyContainer.appendChild(div);
            });
        }

        function spin() {
            if (isSpinning || capsules.length === 0) return;

            // 啟動音訊環境 (處理瀏覽器限制)
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }

            isSpinning = true;
            exitCapsule.classList.add('hidden');
            slotGlow.classList.remove('hidden');
            spinner.classList.remove('hidden');
            playIcon.classList.add('hidden');
            
            // 旋轉旋鈕
            knobPart1.style.transform = 'rotate(720deg)';
            knobPart2.style.transform = 'rotate(630deg)';
            
            renderCapsules(); // 啟動 churn 動畫

            // 開始扭動音效循環
            spinInterval = setInterval(playClickSound, 120);

            setTimeout(() => {
                const randomIndex = Math.floor(Math.random() * capsules.length);
                const selected = capsules[randomIndex];
                
                capsules.splice(randomIndex, 1);
                history.unshift(selected);
                
                isSpinning = false;
                
                // 停止扭動音效
                clearInterval(spinInterval);
                
                // 重置旋鈕
                knobPart1.style.transform = 'rotate(45deg)';
                knobPart2.style.transform = '-rotate(45deg)';
                spinner.classList.add('hidden');
                playIcon.classList.remove('hidden');
                slotGlow.classList.add('hidden');
                
                // 顯示掉落扭蛋
                exitCapsule.className = `w-12 h-12 rounded-full ${colors[selected-1]} animate-drop shadow-lg border-2 border-white/50 relative`;
                exitCapsule.classList.remove('hidden');
                
                renderCapsules();
                renderHistory();

                // 延遲顯示彈窗並播放抽出音效
                setTimeout(() => {
                    playWinSound(); // 播放勝出音效
                    resultNumber.innerText = selected;
                    modalCapsule.className = `w-36 h-36 rounded-full ${colors[selected-1]} flex items-center justify-center text-white text-6xl font-black shadow-2xl relative border-4 border-white animate-bounce`;
                    modalGlow.className = `absolute -inset-4 rounded-full blur-xl opacity-50 ${colors[selected-1]}`;
                    capsuleLabel.innerText = `Capsule #${selected}`;
                    modal.classList.remove('hidden');
                }, 600);

            }, 2000);
        }

        function reset() {
            capsules = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
            history = [];
            exitCapsule.classList.add('hidden');
            renderCapsules();
            renderHistory();
        }

        spinButton.addEventListener('click', spin);
        resetButton.addEventListener('click', reset);
        closeModal.addEventListener('click', () => modal.classList.add('hidden'));

        // 初始渲染
        renderCapsules();
    </script>
</body>
</html>